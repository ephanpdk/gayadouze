<script>
const API = "http://127.0.0.1:8000";
const CLUSTERS = ["Newbie", "Window Shopper", "Loyalist", "Sultan"];
const THEMES = [
    { bg: "bg-slate-50", border: "border-slate-200", text: "text-slate-700", icon: "fa-seedling", color: "text-slate-400" },
    { bg: "bg-blue-50", border: "border-blue-200", text: "text-blue-700", icon: "fa-binoculars", color: "text-blue-500" },
    { bg: "bg-emerald-50", border: "border-emerald-200", text: "text-emerald-700", icon: "fa-handshake", color: "text-emerald-500" },
    { bg: "bg-amber-50", border: "border-amber-200", text: "text-amber-900", icon: "fa-crown", color: "text-amber-500" }
];

let token = localStorage.getItem('token');
let user = localStorage.getItem('user');
let metrics = null;

let chartInstance=null, pieChartInstance=null, elbowChartInstance=null;
let pcaInstance=null, silInstance=null, corrInstance=null, impInstance=null, simInstance=null;

let sessionLogs = [];

function init() {
    renderAuth();
    bindSliders();
    updateLiveSimulator();
    loadMetrics();
    const logs = localStorage.getItem('sessionLogs');
    if(logs) {
        try {
            sessionLogs = JSON.parse(logs);
            const table = document.getElementById('log-table');
            if(sessionLogs.length > 0 && table) {
                table.innerHTML = '';
                sessionLogs.forEach(l => {
                    table.innerHTML += `<tr class="hover:bg-slate-50 transition border-b border-slate-50"><td class="px-6 py-2 text-xs text-slate-400 font-mono">${l.time}</td><td class="px-6 py-2 text-xs font-bold ${THEMES[l.cluster].text}">${CLUSTERS[l.cluster]}</td><td class="px-6 py-2 text-xs text-right font-bold text-slate-600">$${l.money}</td><td class="px-6 py-2 text-center"><i class="fa-solid fa-check text-emerald-500 text-xs"></i></td></tr>`;
                });
            }
        } catch(e) {}
    }
}

function updateLiveSimulator() {
    const money = parseFloat(document.getElementById('in-money').value);
    const freq = parseInt(document.getElementById('in-freq').value);
    const views = parseInt(document.getElementById('in-views').value);
    const cart = parseInt(document.getElementById('in-cart').value);

    const rfmTag = document.getElementById('live-rfm-tag');
    const rfmBar = document.getElementById('indicator-rfm');

    if (money > 2500) {
        rfmTag.innerText = "HIGH ROLLER";
        rfmTag.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-amber-100 text-amber-700 transition-colors";
        rfmBar.className = "absolute top-0 left-0 w-1.5 h-full bg-amber-500 transition-all duration-300";
    } else if (money > 500 && freq > 10) {
        rfmTag.innerText = "CONSISTENT";
        rfmTag.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-emerald-100 text-emerald-700 transition-colors";
        rfmBar.className = "absolute top-0 left-0 w-1.5 h-full bg-emerald-500 transition-all duration-300";
    } else {
        rfmTag.innerText = "CASUAL / LOW";
        rfmTag.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-slate-100 text-slate-500 transition-colors";
        rfmBar.className = "absolute top-0 left-0 w-1 h-full bg-slate-300 transition-all duration-300";
    }

    const engTag = document.getElementById('live-eng-tag');
    const engBar = document.getElementById('indicator-eng');

    if (views > 200 || cart > 20) {
        engTag.innerText = "HYPER ACTIVE";
        engTag.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-blue-100 text-blue-700 transition-colors";
        engBar.className = "absolute top-0 left-0 w-1.5 h-full bg-blue-500 transition-all duration-300";
    } else if (views > 50) {
        engTag.innerText = "BROWSING";
        engTag.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-pink-100 text-pink-700 transition-colors";
        engBar.className = "absolute top-0 left-0 w-1.5 h-full bg-pink-500 transition-all duration-300";
    } else {
        engTag.innerText = "DORMANT";
        engTag.className = "px-3 py-1 rounded-full text-[10px] font-bold bg-slate-100 text-slate-500 transition-colors";
        engBar.className = "absolute top-0 left-0 w-1 h-full bg-slate-300 transition-all duration-300";
    }
}

function handleLogin() { doAuth('login'); }
function handleRegister() { doAuth('register'); }

function switchView(viewName) {
    ['view-dashboard', 'view-insights', 'view-pipeline'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
    });

    const target = document.getElementById(`view-${viewName}`);
    if(target) target.classList.remove('hidden');

    ['nav-dashboard', 'nav-insights', 'nav-pipeline'].forEach(id => {
        const btn = document.getElementById(id);
        if(btn) btn.className = "px-4 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition flex items-center gap-2";
    });

    const activeBtn = document.getElementById(`nav-${viewName}`);
    if(activeBtn) {
        activeBtn.className = "px-4 py-1.5 rounded-md text-xs font-bold transition flex items-center gap-2 bg-indigo-600 text-white shadow-md";
    }

    if(viewName === 'insights') {
        if(!metrics) {
            loadMetrics().then(() => { setTimeout(renderCharts, 100); });
        } else setTimeout(renderCharts, 50);
    }
}

function toggleModal(id) {
    if(id === 'specsModal' || id === 'aboutModal') { switchView('pipeline'); return; }
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.toggle('hidden');
}

function showInsights() { switchView('insights'); }

async function loadMetrics() {
    try {
        const res = await fetch(`${API}/cluster/metrics`);
        if(res.ok) metrics = await res.json();
    } catch(e) {}
}

function renderCharts() {
        if(!metrics || !metrics.centroids_real) return;

        const silEl = document.getElementById('valSil');
        const inertiaEl = document.getElementById('valInertia');
        if(silEl) silEl.innerText = metrics.silhouette_score;
        if(inertiaEl) inertiaEl.innerText = Math.round(metrics.inertia);

        // 1. PCA SCATTER
        const ctxPca = document.getElementById('chart-pca');
        if(ctxPca && !pcaInstance && metrics.advanced_viz) {
            const scatterData = metrics.advanced_viz.pca_scatter;
            const colors = ['#94a3b8', '#3b82f6', '#10b981', '#f59e0b'];
            const datasets = CLUSTERS.map((name, i) => ({
                label: name,
                data: scatterData.filter(d => d.cluster === i).map(d => ({x: d.x, y: d.y})),
                backgroundColor: colors[i]
            }));

            pcaInstance = new Chart(ctxPca, {
                type: 'scatter',
                data: { datasets: datasets },
                options: { 
                    maintainAspectRatio: false,
                    scales: { x: {display:false}, y: {display:false} }, 
                    plugins: { legend: {position:'bottom', labels: {usePointStyle: true}} } 
                }
            });
        }

        // 2. SILHOUETTE
        const ctxSil = document.getElementById('chart-silhouette');
        if(ctxSil && !silInstance && metrics.advanced_viz) {
            silInstance = new Chart(ctxSil, {
                type: 'bar',
                data: {
                    labels: CLUSTERS,
                    datasets: [{ label: 'Coefficient', data: metrics.advanced_viz.silhouette_per_cluster, backgroundColor: ['#94a3b8', '#3b82f6', '#10b981', '#f59e0b'] }]
                },
                options: { 
                    maintainAspectRatio: false,
                    indexAxis: 'y', 
                    plugins: { legend: {display:false} }, 
                    scales: { x: {min: -0.1, max: 1} } 
                }
            });
        }

        // 3. CORRELATION
        const ctxCorr = document.getElementById('chart-correlation');
        if(ctxCorr && !corrInstance && metrics.advanced_viz) {
            const corrData = metrics.advanced_viz.correlation_matrix;
            const bubbleData = [];
            const feats = ['Rec', 'Freq', 'Mon', 'View', 'Cart']; 
            
            for(let i=0; i<5; i++) {
                for(let j=0; j<5; j++) {
                    const val = corrData[i][j];
                    bubbleData.push({x: i, y: j, r: Math.abs(val)*10, v: val});
                }
            }

            corrInstance = new Chart(ctxCorr, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Correlation',
                        data: bubbleData,
                        backgroundColor: ctx => ctx.raw.v > 0 ? 'rgba(99, 102, 241, 0.7)' : 'rgba(244, 63, 94, 0.7)'
                    }]
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: {display:false}, tooltip: {callbacks: {label: (c)=> `Corr: ${c.raw.v}`}} },
                    scales: { 
                        x: { type: 'category', labels: feats, grid: {display:false} },
                        y: { type: 'category', labels: feats, grid: {display:false} }
                    }
                }
            });
        }

        // 4. IMPORTANCE
        const ctxImp = document.getElementById('chart-importance');
        if(ctxImp && !impInstance && metrics.advanced_viz) {
            impInstance = new Chart(ctxImp, {
                type: 'bar',
                data: {
                    labels: metrics.advanced_viz.feature_importance.labels.slice(0,5),
                    datasets: [{ label: 'Importance', data: metrics.advanced_viz.feature_importance.data.slice(0,5), backgroundColor: '#cbd5e1' }]
                },
                options: { 
                    maintainAspectRatio: false,
                    plugins: { legend: {display:false} } 
                }
            });
        }

        // 5. SIMILARITY
        const ctxSim = document.getElementById('chart-similarity');
        if(ctxSim && !simInstance) {
            simInstance = new Chart(ctxSim, {
                type: 'line',
                data: {
                    labels: ['0-20%', '20-40%', '40-60%', '60-80%', '80-100%'],
                    datasets: [{ label: 'Rec. Match Rate', data: [5, 10, 25, 40, 20], fill: true, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4 }]
                },
                options: { 
                    maintainAspectRatio: false,
                    plugins: { legend: {display:false} }, 
                    scales: { y: {display:false}, x: {grid:{display:false}} } 
                }
            });
        }

        // OLD CHARTS (UPDATED OPTIONS)
        
        // ELBOW
        const ctxElbow = document.getElementById('chart-elbow');
        if(ctxElbow) {
            if(elbowChartInstance) elbowChartInstance.destroy();
            elbowChartInstance = new Chart(ctxElbow.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Object.keys(metrics.elbow_curve),
                    datasets: [{ label: 'Inertia', data: Object.values(metrics.elbow_curve), borderColor: '#4f46e5', tension: 0.3, pointBackgroundColor: '#4f46e5' }]
                },
                options: { 
                    maintainAspectRatio: false,
                    plugins: {legend:{display:false}}, 
                    scales:{x:{grid:{display:false}}, y:{grid:{color:'#f1f5f9'}}} 
                }
            });
        }

        // PIE
        const ctxPie = document.getElementById('chart-pie');
        if(ctxPie) {
            if(pieChartInstance) pieChartInstance.destroy();
            pieChartInstance = new Chart(ctxPie.getContext('2d'), {
                type: 'doughnut',
                data: { labels: CLUSTERS, datasets: [{ data: Object.values(metrics.cluster_counts), backgroundColor: ['#94a3b8', '#3b82f6', '#10b981', '#f59e0b'], borderWidth:0 }] },
                options: { 
                    maintainAspectRatio: false,
                    cutout: '70%', 
                    plugins: { legend: { position: 'bottom', labels:{usePointStyle:true, font:{size:10}} } } 
                }
            });
        }

        // RADAR
        const ctxRadar = document.getElementById('chart-radar');
        if(ctxRadar) {
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctxRadar.getContext('2d'), {
                type: 'radar',
                data: { labels: metrics.feature_readable, datasets: metrics.centroids_scaled.map((d, i) => ({ label: CLUSTERS[i], data: d, borderColor: ['#94a3b8', '#3b82f6', '#10b981', '#f59e0b'][i], fill: false, borderWidth: 2, pointRadius: 0 })) },
                options: { 
                    maintainAspectRatio: false,
                    layout: { padding: 20 }, // Memberi jarak agar label tidak terpotong
                    scales: { 
                        r: { 
                            suggestedMin: -1, 
                            suggestedMax: 3, 
                            ticks: {display:false}, 
                            grid: {color:'#f1f5f9'},
                            pointLabels: { font: {size: 11, weight: 'bold'} } 
                        } 
                    }, 
                    plugins: { legend: { display: false } } 
                }
            });
        }

        const tableBody = document.getElementById('table-centroids');
        if(tableBody) {
             tableBody.innerHTML = metrics.centroids_real.map((c, i) => `
                <tr class="hover:bg-slate-50 border-b border-slate-50">
                    <td class="px-6 py-2 font-bold text-[10px] uppercase ${THEMES[i].text}">${CLUSTERS[i]}</td>
                    <td class="px-6 py-2 text-right font-mono text-[10px]">$${Math.round(c.Monetary)}</td>
                    <td class="px-6 py-2 text-right font-mono text-[10px]">${Math.round(c.Frequency)}</td>
                    <td class="px-6 py-2 text-right font-mono text-[10px]">${Math.round(c.Recency)}d</td>
                    <td class="px-6 py-2 text-right font-mono text-[10px]">${Math.round(c.Page_Views)}</td>
                </tr>
            `).join('');
        }
    }
function renderAuth() {
    const area = document.getElementById('auth-section');
    if(!area) return;

    if(token) {
        const init = user ? user[0].toUpperCase() : 'U';
        area.innerHTML = `
            <div class="flex items-center gap-3 ml-4 pl-4 border-l border-slate-200">
                <div class="text-right hidden sm:block">
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Active</div>
                    <div class="text-xs font-bold text-slate-900">${user}</div>
                </div>
                <div class="h-9 w-9 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center font-bold text-slate-600 text-xs">${init}</div>
                <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition ml-1"><i class="fa-solid fa-power-off"></i></button>
            </div>`;
    } else {
        area.innerHTML = `<button onclick="toggleModal('authModal')" class="ml-4 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-5 py-2 rounded-lg transition shadow-lg shadow-indigo-200">LOGIN ACCESS</button>`;
    }
}

async function doAuth(type) {
    const email = type==='login' ? document.getElementById('loginEmail').value : document.getElementById('regEmail').value;
    const pass = type==='login' ? document.getElementById('loginPass').value : document.getElementById('regPass').value;
    const name = type==='register' ? document.getElementById('regName').value : null;

    if(!email || !pass) return toast('Input required', 'error');

    const endpoint = type==='login' ? '/auth/login' : '/auth/register';
    const body = type==='login' ? {email, password: pass} : {email, password: pass, name};

    try {
        const res = await fetch(`${API}${endpoint}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
        if(res.ok) {
            if(type==='register') {
                toast('Account created', 'success');
                switchAuthTab('login');
            } else {
                const data = await res.json();
                localStorage.setItem('token', data.access_token);
                localStorage.setItem('user', email.split('@')[0]);
                token = data.access_token;
                user = email.split('@')[0];
                toggleModal('authModal');
                renderAuth();
                toast('Login Successful', 'success');
            }
        } else toast('Auth Failed', 'error');
    } catch(e) { toast('Connection Error', 'error'); }
}

function switchAuthTab(type) {
    document.getElementById('loginForm').classList.toggle('hidden', type !== 'login');
    document.getElementById('registerForm').classList.toggle('hidden', type === 'login');
    document.getElementById('tabLogin').className = type==='login' ? "flex-1 py-2 text-xs font-bold rounded-md bg-white shadow-sm text-slate-800 transition" : "flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-700 transition";
    document.getElementById('tabRegister').className = type!=='login' ? "flex-1 py-2 text-xs font-bold rounded-md bg-white shadow-sm text-slate-800 transition" : "flex-1 py-2 text-xs font-bold rounded-md text-slate-500 hover:text-slate-700 transition";
}

function logout() {
    localStorage.clear();
    token=null;
    user=null;
    renderAuth();
    toast('Logged Out', 'info');
}

function bindSliders() {
    const updateVal = (id, val, pre='', post='') => {
        const key = id.split('-')[1];
        const el = document.getElementById(`disp-${key}`);
        if(el) el.innerText = pre + val + post;
    };

    document.getElementById('in-money').addEventListener('input', (e) => { updateVal(e.target.id, e.target.value, '$'); updateLiveSimulator(); });
    document.getElementById('in-freq').addEventListener('input', (e) => { updateVal(e.target.id, e.target.value); updateLiveSimulator(); });
    document.getElementById('in-rec').addEventListener('input', (e) => { updateVal(e.target.id, e.target.value, '', ' days'); updateLiveSimulator(); });
    document.getElementById('in-views').addEventListener('input', (e) => { updateVal(e.target.id, e.target.value); updateLiveSimulator(); });
    document.getElementById('in-cart').addEventListener('input', (e) => { updateVal(e.target.id, e.target.value); updateLiveSimulator(); });
    document.getElementById('in-wish').addEventListener('input', (e) => { updateVal(e.target.id, e.target.value); updateLiveSimulator(); });
}

function generateInsights(payload, clusterIdx) {
    if(!metrics || !metrics.centroids_real) return {
        why: "Data metrics not loaded yet.",
        compare: "Cannot compare without baseline.",
        anomaly: "Unknown."
    };

    const centroid = metrics.centroids_real[clusterIdx];
    let why = "User behavior aligns with standard segment profile.";

    if (payload.Page_Views > centroid.Page_Views * 1.2 && payload.Frequency < centroid.Frequency) {
        why = "High engagement intent detected, but conversion rate lags behind segment average.";
    } else if (payload.Page_Views < centroid.Page_Views * 0.8 && payload.Monetary > centroid.Monetary) {
        why = "Decisive buyer pattern: High transaction value with minimal browsing time.";
    } else if (payload.Add_to_Cart_Count > centroid.Add_to_Cart_Count * 1.5 && payload.Frequency <= centroid.Frequency) {
        why = "Cart abandonment risk: User adds significantly more items than they purchase.";
    } else if (payload.Monetary > centroid.Monetary && payload.Recency > 60) {
        why = "Dormant VIP: High historical value but inactive for an extended period.";
    }

    const diffMoney = ((payload.Monetary - centroid.Monetary) / centroid.Monetary) * 100;

    let pressure = "Stable";
    if (payload.Recency > 90) pressure = "High Risk (Churn)";
    else if (payload.Recency > 45 && payload.Monetary > 2000) pressure = "Medium Risk";
    else if (payload.Recency < 7 && payload.Frequency > 10) pressure = "High Opportunity";

    const compare = `Spending ${Math.abs(diffMoney).toFixed(1)}% ${diffMoney >= 0 ? 'above' : 'below'} avg. Status: ${pressure}.`;

    let action = "Maintain standard communication.";
    if (pressure.includes("Churn") && payload.Monetary > 1500) action = "ðŸš¨ URGENT: Deploy Win-back Campaign via Direct Call/SMS.";
    else if (payload.Page_Views > 60 && payload.Frequency === 0) action = "ðŸ’¡ OPPORTUNITY: Send First-Purchase Discount Coupon.";
    else if (payload.Add_to_Cart_Count > 10 && payload.Recency < 3) action = "ðŸ”¥ HOT LEAD: Trigger 'Items in Cart' Reminder immediately.";
    else if (clusterIdx === 3 && payload.Recency < 14) action = "â­ VIP: Offer Early Access to New Collections.";
    else if (payload.Wishlist_Count > 5) action = "ðŸ”” NUDGE: Notify regarding stock availability for wishlist.";

    return { why, compare, anomaly: action };
}

function setPreset(type) {
    const presets = {
        'newbie': { money: 30, freq: 2, rec: 60, views: 5, cart: 1, wish: 0, avg: 1.2, unique: 1 },
        'window': { money: 100, freq: 5, rec: 15, views: 150, cart: 8, wish: 10, avg: 2.0, unique: 3 },
        'loyalist': { money: 800, freq: 25, rec: 7, views: 40, cart: 15, wish: 5, avg: 3.5, unique: 10 },
        'sultan': { money: 5000, freq: 45, rec: 3, views: 80, cart: 30, wish: 20, avg: 5.0, unique: 25 }
    };

    const p = presets[type];
    if(!p) return;

    const setVal = (id, val) => {
        const el = document.getElementById(id);
        if(el) {
            el.value = val;
            el.dispatchEvent(new Event('input'));
        }
    };

    setVal('in-money', p.money);
    setVal('in-freq', p.freq);
    setVal('in-rec', p.rec);
    setVal('in-views', p.views);
    setVal('in-cart', p.cart);
    setVal('in-wish', p.wish);

    toast(`Preset Applied: ${type.toUpperCase()}`, 'info');
}

function resetSim() {
    document.getElementById('in-money').value=1000;
    document.getElementById('disp-money').innerText='$1000';
    document.getElementById('in-freq').value=5;
    document.getElementById('in-rec').value=30;
    document.getElementById('in-views').value=50;
    document.getElementById('disp-views').innerText='50';
    document.getElementById('in-cart').value=15;
    document.getElementById('disp-cart').innerText='15';
    updateLiveSimulator();
    toast('Reset', 'info');
}

async function runPrediction() {
    if(!token) { toggleModal('authModal'); toast('Login Required', 'error'); return; }

    const freqVal = parseInt(document.getElementById('in-freq').value);
    const estimatedUnique = Math.max(1, Math.ceil(freqVal * 0.5));

    const payload = {
        Monetary: parseFloat(document.getElementById('in-money').value),
        Frequency: freqVal,
        Recency: parseInt(document.getElementById('in-rec').value),
        Page_Views: parseInt(document.getElementById('in-views').value),
        Add_to_Cart_Count: parseInt(document.getElementById('in-cart').value),
        Wishlist_Count: parseInt(document.getElementById('in-wish').value),
        Avg_Items: 2.5,
        Unique_Products: estimatedUnique 
    };

    document.getElementById('state-idle').classList.add('hidden');
    document.getElementById('state-result').classList.remove('hidden');
    document.getElementById('cluster-name').innerHTML = '<span class="animate-pulse">Analyzing...</span>';

    try {
        const res = await fetch(`${API}/recommend/user`, {
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization': `Bearer ${token}`},
            body:JSON.stringify(payload)
        });

        if(res.ok) {
            const data = await res.json();
            renderResult(data);
            addLog(data.cluster, payload.Monetary);
            toast('Success', 'success');
        } else {
            if(res.status===401) logout();
            else toast('API Error', 'error');
        }
    } catch(e) { toast('Server Error', 'error'); }
}

function renderResult(data) {
    const theme = THEMES[data.cluster] || THEMES[0];
    const name = CLUSTERS[data.cluster] || "Unknown";

    document.getElementById('cluster-name').innerText = name;
    document.getElementById('cluster-name').className = `text-3xl font-bold ${theme.text} leading-none`;
    document.getElementById('cluster-icon').className = `fa-solid ${theme.icon}`;
    document.getElementById('cluster-icon-box').className = `w-16 h-16 rounded-2xl flex items-center justify-center text-3xl mb-4 shadow-sm ${theme.bg} ${theme.color}`;
    document.getElementById('hero-card').className = `relative bg-white rounded-2xl border ${theme.border} p-8 overflow-hidden shadow-sm transition-all duration-500 fade-enter`;

    document.getElementById('res-dist').innerText = Number(data.metrics?.distance_to_centroid ?? 0).toFixed(4);
    document.getElementById('res-conf').innerText = (data.metrics?.confidence_score ?? 0) + '%';

    const drivers = data.metrics?.feature_drivers || [];
    document.getElementById('driver-list').innerHTML = drivers.length
        ? drivers.map(d => `<li class="flex items-center gap-2 text-xs text-slate-600"><i class="fa-solid ${d.sentiment==='positive'?'fa-arrow-trend-up text-emerald-500':'fa-arrow-trend-down text-rose-500'}"></i><span class="font-bold">${d.feature}</span><span class="text-slate-400">(${d.description}, Z=${d.score.toFixed(2)})</span></li>`).join('')
        : '<li class="text-sm text-slate-400 italic">Balanced behavior.</li>';

    const currentPayload = {
        Monetary: parseFloat(document.getElementById('in-money').value),
        Frequency: parseInt(document.getElementById('in-freq').value),
        Recency: parseInt(document.getElementById('in-rec').value),
        Page_Views: parseInt(document.getElementById('in-views').value),
        Add_to_Cart_Count: parseInt(document.getElementById('in-cart').value),
        Wishlist_Count: parseInt(document.getElementById('in-wish').value)
    };

    const insights = generateInsights(currentPayload, data.cluster);

    document.getElementById('bs-why').innerText = insights.why;
    document.getElementById('bs-compare').innerText = insights.compare;

    const anomalyEl = document.getElementById('bs-anomaly');
    anomalyEl.innerText = insights.anomaly;

    if(insights.anomaly.includes("URGENT")) {
        anomalyEl.className = "text-[10px] font-bold text-red-600 bg-red-50 p-2 rounded border border-red-100 mt-auto animate-pulse";
    } else if (insights.anomaly.includes("OPPORTUNITY") || insights.anomaly.includes("HOT")) {
        anomalyEl.className = "text-[10px] font-bold text-emerald-600 bg-emerald-50 p-2 rounded border border-emerald-100 mt-auto";
    } else {
        anomalyEl.className = "text-[10px] font-bold text-slate-600 bg-slate-50 p-2 rounded border border-slate-200 mt-auto";
    }

    document.getElementById('product-grid').innerHTML = (data.recommendations||[]).map(p => `
        <div class="group bg-white border border-slate-100 rounded-xl p-4 hover:shadow-xl transition-all relative">
            <div class="h-32 bg-slate-50 rounded-lg mb-4 relative overflow-hidden">
                <img src="https://picsum.photos/seed/${p.product_id}/300/200" class="w-full h-full object-cover opacity-90">
                <div class="absolute top-2 left-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-[10px] font-bold text-slate-600">${p.category}</div>
            </div>
            <h4 class="font-bold text-slate-800 text-sm mb-2">${p.name}</h4>
            <div class="flex justify-between items-center pt-3 border-t border-slate-50">
                <span class="font-mono font-bold text-slate-900">$${p.price}</span>
                <button class="w-8 h-8 rounded-lg bg-slate-900 text-white flex items-center justify-center hover:bg-indigo-600 transition shadow-lg active:scale-90">
                    <i class="fa-solid fa-plus text-xs"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function addLog(cluster, money) {
    const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    let logs = JSON.parse(localStorage.getItem('sessionLogs') || '[]');
    logs.unshift({cluster, money, time});
    if(logs.length > 10) logs.pop();
    localStorage.setItem('sessionLogs', JSON.stringify(logs));

    const table = document.getElementById('log-table');
    if(table) {
        if(table.innerHTML.includes('No activity')) table.innerHTML = '';
        table.innerHTML = `<tr class="hover:bg-slate-50 transition border-b border-slate-50 fade-enter"><td class="px-6 py-2 text-xs text-slate-400 font-mono">${time}</td><td class="px-6 py-2 text-xs font-bold ${THEMES[cluster].text}">${CLUSTERS[cluster]}</td><td class="px-6 py-2 text-xs text-right font-bold text-slate-600">$${money}</td><td class="px-6 py-2 text-center"><i class="fa-solid fa-circle-check text-emerald-500 text-xs"></i></td></tr>` + table.innerHTML;
    }
}

function toast(msg, type='info') {
    const d = document.createElement('div');
    const c = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-500' : 'bg-slate-800';
    d.className = `${c} text-white px-4 py-3 rounded-lg shadow-xl text-xs font-bold flex items-center gap-3 transform transition-all duration-300 translate-x-full opacity-0 backdrop-blur-md z-[100] mb-2 pointer-events-none`;
    d.innerHTML = `<i class="fa-solid ${type==='success'?'fa-check':'fa-info'}"></i> ${msg}`;
    const container = document.getElementById('toast-container');
    if (container) {
        container.appendChild(d);
        setTimeout(() => d.classList.remove('translate-x-full', 'opacity-0'), 10);
        setTimeout(() => d.remove(), 3000);
    }
}

init();
</script>
